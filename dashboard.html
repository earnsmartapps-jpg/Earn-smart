<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Earn Smart - Dashboard</title>

<style>
body{
  margin:0;
  font-family:'Segoe UI',sans-serif;
  background:linear-gradient(135deg,#0f2027,#1e3c72,#2a5298);
  color:white;
}
.container{padding:20px;max-width:900px;margin:auto;}
.card{
  background:rgba(255,255,255,0.08);
  padding:20px;
  border-radius:12px;
  margin-bottom:20px;
}
button{
  padding:10px;
  border:none;
  border-radius:8px;
  background:#22c55e;
  color:white;
  cursor:pointer;
}
button:hover{background:#16a34a;}
input,select{
  width:100%;
  padding:10px;
  margin:8px 0;
  border-radius:8px;
  border:none;
}
.small{font-size:12px;color:#ccc;}
</style>
</head>
<body>

<div class="container">

<h2>Dashboard</h2>

<div class="card">
<h3>Balance: $<span id="balance">0</span></h3>
</div>

<!-- DEPOSIT TO INVEST -->
<div class="card">
<h3>Deposit To Activate Plan</h3>
<select id="planSelect">
<option value="starter">Starter - $5 (5% daily 30 days)</option>
<option value="silver">Silver - $10 (5% daily 30 days)</option>
<option value="diamond">Diamond - $20 (10% daily 30 days)</option>
</select>
<button onclick="investPlan()">Deposit Now</button>
<p class="small">Send exact amount. Admin must approve before balance updates.</p>
</div>

<!-- INVEST FROM BALANCE -->
<div class="card">
<h3>Start Investment (After Deposit Approval)</h3>
<button onclick="startInvestment()">Use Balance To Invest</button>
</div>

<!-- WITHDRAW -->
<div class="card">
<h3>Withdraw</h3>
<input type="number" id="withdrawAmount" placeholder="Amount">
<input type="text" id="withdrawWallet" placeholder="Wallet">
<select id="withdrawNetwork">
<option>TRC20</option>
<option>BSC BEP20</option>
<option>ERC20</option>
</select>
<button onclick="requestWithdraw()">Request Withdrawal</button>
</div>

<div class="card">
<h3>My Investments</h3>
<div id="investments"></div>
</div>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getDatabase, ref, push, onValue, get, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAZP0UPvfCgiiir2zKLMae25dUpVcyP3iw",
  authDomain: "crypto-gainz-3524d.firebaseapp.com",
  databaseURL: "https://crypto-gainz-3524d-default-rtdb.firebaseio.com",
  projectId: "crypto-gainz-3524d",
  storageBucket: "crypto-gainz-3524d.firebasestorage.app",
  messagingSenderId: "270349829717",
  appId: "1:270349829717:web:6e3e2bf25f9ab60b2a76dc"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

const LOCK = 30*24*60*60*1000;

onAuthStateChanged(auth,(user)=>{
if(!user){window.location="index.html";return;}
loadUser(user);
loadInvestments(user);
});

/* LOAD USER */
function loadUser(user){
onValue(ref(db,'users/'+user.uid),(snap)=>{
document.getElementById("balance").innerText =
(snap.val()?.balance||0).toFixed(2);
});
}

/* =========================
   STEP 1: DEPOSIT SYSTEM
=========================*/
window.investPlan = async()=>{
const user = auth.currentUser;
const plan = document.getElementById("planSelect").value;

let amount= plan==="starter"?5:plan==="silver"?10:20;

const network = prompt("Select Network:\n1 = TRC20\n2 = BSC BEP20\n3 = ERC20");

let wallet="";
let networkName="";

if(network=="1"){
wallet="TKJAvkyjdDSzKtS1HihiKno1tTfi2bTJJe";
networkName="USDT TRC20";
}
else if(network=="2"){
wallet="0xB66E1e0e5452489298bebd7Cd463587E6866baD2";
networkName="BSC BEP20";
}
else if(network=="3"){
wallet="0xB66E1e0e5452489298bebd7Cd463587E6866baD2";
networkName="USDT ERC20";
}
else{
alert("Invalid selection");
return;
}

alert("Send $" + amount + " to:\n\n" + wallet + "\n\nAfter payment, admin will approve.");

await push(ref(db,'deposits'),{
uid:user.uid,
amount,
plan,
network:networkName,
status:"pending",
date:Date.now()
});

alert("Deposit request submitted. Wait for admin approval.");
};

/* =========================
   STEP 2: START INVESTMENT
=========================*/
window.startInvestment = async()=>{
const user=auth.currentUser;
const plan=document.getElementById("planSelect").value;
let amount= plan==="starter"?5:plan==="silver"?10:20;

const snap=await get(ref(db,'users/'+user.uid));
let balance=snap.val()?.balance||0;

if(balance<amount) return alert("Deposit must be approved first.");

await update(ref(db,'users/'+user.uid),{
balance:balance-amount
});

await push(ref(db,'investments/'+user.uid),{
amount,
plan,
startDate:Date.now(),
paid:false
});

alert("Investment Started");
};

/* =========================
   WITHDRAW (SAFE)
=========================*/
window.requestWithdraw = async()=>{
const user=auth.currentUser;
const amount=parseFloat(document.getElementById("withdrawAmount").value);
const wallet=document.getElementById("withdrawWallet").value;
const network=document.getElementById("withdrawNetwork").value;

if(!amount||!wallet) return alert("Fill all fields");

const userSnap=await get(ref(db,'users/'+user.uid));
let balance=userSnap.val()?.balance||0;

if(amount>balance) return alert("Cannot withdraw more than balance");

const pendingSnap=await get(ref(db,'withdrawals/'+user.uid));
if(pendingSnap.exists()) return alert("You already have pending withdrawal");

await push(ref(db,'withdrawals/'+user.uid),{
amount,
wallet,
network,
status:"pending",
date:Date.now()
});

alert("Withdrawal request submitted");
};

/* =========================
   MATURITY SYSTEM
=========================*/
function loadInvestments(user){
onValue(ref(db,'investments/'+user.uid),(snap)=>{
const data=snap.val();
if(!data) return;

let html="";

for(const id in data){
const inv=data[id];
const days=Math.floor((Date.now()-inv.startDate)/(24*60*60*1000));

if(days>=30 && !inv.paid){
html+=`
<div>
Plan $${inv.amount} matured
<button onclick="claimProfit('${id}',${inv.amount})">Claim</button>
</div>`;
}else{
html+=`<div>Plan $${inv.amount} - ${days}/30 days</div>`;
}
}
document.getElementById("investments").innerHTML=html;
});
}

window.claimProfit = async(id,amount)=>{
const user=auth.currentUser;
const rate= amount===20?0.10:0.05;
const totalProfit=amount + (amount*rate*30);

const userRef=ref(db,'users/'+user.uid);
const snap=await get(userRef);
let balance=snap.val()?.balance||0;

await update(userRef,{balance:balance+totalProfit});
await update(ref(db,'investments/'+user.uid+'/'+id),{paid:true});

alert("Profit Claimed");
};

</script>
</body>
</html>
