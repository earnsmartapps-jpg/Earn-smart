<script type="module">
import { auth, db } from './firebase.js';
import { ref, push, onValue, get }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const LOCK = 30*24*60*60*1000;
let chart;

const totalEl = document.getElementById("total");
const activeEl = document.getElementById("active");
const maturedEl = document.getElementById("matured");
const chartCanvas = document.getElementById("chart");
const transactionsEl = document.getElementById("transactions");
const refLinkEl = document.getElementById("refLink");

auth.onAuthStateChanged(async user=>{
  if(!user){
    location="index.html";
    return;
  }

  const userSnap = await get(ref(db,'users/'+user.uid));
  const userData = userSnap.val();

  if(userData?.referralCode){
    refLinkEl.innerText =
      location.origin+"/index.html?ref="+userData.referralCode;
  }

  const investRef = ref(db,'investments/'+user.uid);

  onValue(investRef,(snap)=>{
    const data=snap.val();
    if(!data){
      totalEl.innerText="$0";
      activeEl.innerText="0";
      maturedEl.innerText="0";
      return;
    }

    let total=0, active=0, matured=0;
    const amounts=[];

    Object.values(data).forEach(inv=>{
      total+=inv.amount;
      amounts.push(inv.amount);

      if(Date.now()-inv.startDate>=LOCK){
        matured++;
      } else {
        active++;
      }
    });

    totalEl.innerText="$"+total;
    activeEl.innerText=active;
    maturedEl.innerText=matured;

    if(chart) chart.destroy();

    chart=new Chart(chartCanvas,{
      type:"bar",
      data:{
        labels:amounts.map((_,i)=> "Investment "+(i+1)),
        datasets:[{
          label:"Amount",
          data:amounts
        }]
      }
    });
  });

  const transRef = ref(db,'transactions/'+user.uid);
  onValue(transRef,(snap)=>{
    const data=snap.val();
    if(!data){
      transactionsEl.innerHTML="";
      return;
    }

    let html="";
    Object.values(data).forEach(t=>{
      html+=`
      <div class="card">
        ${t.type} - $${t.amount}
      </div>`;
    });

    transactionsEl.innerHTML=html;
  });
});

window.invest=async amount=>{
  const user=auth.currentUser;
  if(!user) return;

  await push(ref(db,'investments/'+user.uid),{
    amount,
    startDate:Date.now()
  });

  await push(ref(db,'transactions/'+user.uid),{
    type:"deposit",
    amount,
    date:Date.now()
  });

  alert("Investment added");
};
    </script>
